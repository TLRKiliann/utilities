<h1 id="api-2">API 2</h1>
<p>Le code que vous avez partagé pour mettre à jour les dates des
entrées du CMS est bien structuré, mais il y a quelques détails et
améliorations que vous pourriez considérer pour assurer un bon
fonctionnement.</p>
<h2 id="correction-des-étapes-et-suggestions">Correction des étapes et
suggestions</h2>
<style>
    pre {
        font-size: 1.0rem;
        background-color: #222;
        color: #00ff00;
            padding: 20px 10px;
            border-radius: 5px;
    }
</style>
<hr />
<h3 id="récupérer-les-données-du-cms">1) Récupérer les Données du
CMS</h3>
<p>Le code pour récupérer les données CMS est correct. Assurez-vous de
remplacer <code>{collection_id}</code> et
<code>{your_access_token}</code> par les valeurs appropriées.</p>
<hr />
<h3 id="calculer-la-date">2) Calculer la Date</h3>
<p>La logique pour ajouter 56 jours est correcte, mais vous ajoutez
<strong>la même date</strong> 8 fois. Vous devriez plutôt calculer une
nouvelle date pour chaque itération.</p>
<h4 id="correction-suggérée">Correction suggérée :</h4>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> calculateNewDates <span class="op">=</span> (currentDate) <span class="kw">=&gt;</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newDates <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> newDate <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(currentDate)<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        newDate<span class="op">.</span><span class="fu">setDate</span>(currentDate<span class="op">.</span><span class="fu">getDate</span>() <span class="op">+</span> (<span class="dv">56</span> <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>)))<span class="op">;</span> <span class="co">// Ajoute 56 jours par </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>itération</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        newDates<span class="op">.</span><span class="fu">push</span>(newDate<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;T&#39;</span>)[<span class="dv">0</span>])<span class="op">;</span> <span class="co">// Format &#39;YYYY-MM-DD&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newDates<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<hr />
<h3 id="mettre-à-jour-le-cms">3) Mettre à Jour le CMS</h3>
<p>Le code pour mettre à jour le CMS est correct. Assurez-vous que
<code>dateField</code> correspond au nom réel du champ de date dans
votre CMS.</p>
<hr />
<h3 id="combiner-les-étapes">4) Combiner les Étapes</h3>
<p>La fonction principale semble fonctionnelle. Cependant, si vous ne
voulez pas que <strong>les nouvelles dates</strong> soient simplement
écrasées par les itérations, assurez-vous que l’ordre des dates
corresponde aux éléments correctement.</p>
<h4 id="correction-suggérée-1">Correction suggérée :</h4>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> updateDatesInWebflow <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> items <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetchCMSData</span>()<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newDates <span class="op">=</span> <span class="fu">calculateNewDates</span>(<span class="kw">new</span> <span class="bu">Date</span>())<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> items<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="fu">updateCMSData</span>(items[i]<span class="op">.</span><span class="at">_id</span><span class="op">,</span> newDates[i])<span class="op">;</span> <span class="co">// Assurez-vous que les index </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>correspondent</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<hr />
<h3 id="automatisation">Automatisation</h3>
<p>Pour exécuter ce script toutes les 8 semaines, vous pouvez utiliser
un service <strong>cron</strong>, qui vous permet de programmer des
scripts à des intervalles spécifiques. Si vous utilisez Node.js, la
bibliothèque <code>node-cron</code> est une bonne option.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cron <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;node-cron&#39;</span>)<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>cron<span class="op">.</span><span class="fu">schedule</span>(<span class="st">&#39;0 0 * * 1&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> { <span class="co">// Execute chaque lundi à minuit</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateDatesInWebflow</span>()<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<hr />
<p>En résumé, le code doit implémenter correctement les calculs de dates
et s’assurer que les mises à jour des entrées CMS soient faites de
manière ordonnée. Vérifiez les détails d’implémentation pour vous
assurer que tout fonctionne sans problème.</p>
<h3 id="automatisation-2">Automatisation 2</h3>
<pre><code>const executeUpdate = async () =&gt; {
    await updateDatesInWebflow(); // Mettre à jour les dates
    // Replanifiez l&#39;exécution dans 8 semaines
    setTimeout(executeUpdate, 56 * 24 * 60 * 60 * 1000); // 56 jours en millisecondes
};

// Fonction pour planifier la première exécution
const scheduleInitialExecution = () =&gt; {
    const now = new Date();
    const nextExecution = new Date(now);
    
    // Calculer le nombre de jours jusqu&#39;au prochain vendredi
    const daysUntilFriday = (5 - now.getDay() + 7) % 7 || 7; // 5 = vendredi
    nextExecution.setDate(now.getDate() + daysUntilFriday);
    nextExecution.setHours(0, 0, 0, 0); // Met à 00h00

    // Initialiser le setTimeout pour la première exécution le prochain vendredi
    const timeUntilNextExecution = nextExecution.getTime() - now.getTime();
    
    // Démarrer le premier timer
    setTimeout(() =&gt; {
        executeUpdate();
        // Démarrer le timer pour la prochaine exécution 8 semaines plus tard
        setTimeout(executeUpdate, 56 * 24 * 60 * 60 * 1000); 
    }, timeUntilNextExecution);
};

// Planifier la première exécution
scheduleInitialExecution();</code></pre>
